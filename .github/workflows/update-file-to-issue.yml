name: Process Route Submission

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process-route:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'route')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Issue and Download
        uses: actions/github-script@v7
        id: parse
        with:
          script: |
            const fs = require('fs');

            const body = context.payload.issue.body;
            // Pattern: geojson: '[file](https://...)'
            // We use a regex that matches the format generated by ShareScreen.tsx
            const match = body.match(/\[file\]\((https:\/\/.*?)\)/);

            if (!match) {
              console.log("No geojson link found in the expected format.");
              return;
            }

            const url = match[1];
            console.log("Found URL:", url);

            // Download the file
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to download: ${response.statusText}`);
            const buffer = await response.arrayBuffer();

            const fileName = `${context.issue.number}.geojson`;
            fs.writeFileSync(fileName, Buffer.from(buffer));

            console.log(`Downloaded ${fileName}`);
            core.setOutput('filename', fileName);
            core.setOutput('download_url', url);

      - name: Push to assets branch
        env:
          FILENAME: ${{ steps.parse.outputs.filename }}
        run: |
          if [ -z "$FILENAME" ]; then
            echo "No filename output, skipping."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Fetch assets branch information
          git fetch origin assets || echo "Assets branch not found on remote"

          if git show-ref --verify --quiet refs/remotes/origin/assets; then
            echo "Checking out existing assets branch"
            git checkout assets
          else
            echo "Creating orphan assets branch"
            git checkout --orphan assets
            git rm -rf .
          fi

          mkdir -p geojson
          # Move the downloaded file (which sits in the root of the workspace) to geojson folder
          # Note: If git checkout switched state, untracked files like our download remain.
          mv "$FILENAME" geojson/

          git add geojson/"$FILENAME"
          git commit -m "Add route file for issue #${{ github.event.issue.number }}"

          # Handle concurrent pushes by rebasing
          git pull --rebase origin assets || echo "Rebase failed or not needed (e.g. orphan branch)"

          git push origin assets

      - name: Update Issue
        uses: actions/github-script@v7
        if: steps.parse.outputs.filename != ''
        env:
          FILENAME: ${{ steps.parse.outputs.filename }}
        with:
          script: |
            const fileName = process.env.FILENAME;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Construct raw URL for assets branch
            const newUrl = `https://raw.githubusercontent.com/${owner}/${repo}/assets/geojson/${fileName}`;

            const oldBody = context.payload.issue.body;
            // Replace the release link with the raw asset link
            const newBody = oldBody.replace(/\[file\]\(.*?\)/, `[file](${newUrl})`);

            await github.rest.issues.update({
              owner: owner,
              repo: repo,
              issue_number: context.issue.number,
              body: newBody,
            });

      - name: Delete from Inbox
        uses: actions/github-script@v7
        if: steps.parse.outputs.download_url != ''
        env:
          DOWNLOAD_URL: ${{ steps.parse.outputs.download_url }}
        with:
          script: |
            const url = process.env.DOWNLOAD_URL;
            console.log(`Processing deletion for URL: ${url}`);

            if (!url.includes('/releases/download/inbox/')) {
               console.log("URL does not look like an inbox release asset. Skipping deletion.");
               return;
            }

            // Extract filename from URL
            const urlParts = url.split('/');
            // The last part is the filename, potentially encoded.
            // GitHub release asset names in API are usually not encoded, but URL is.
            // e.g. URL: .../foo%20bar.geojson -> asset name: foo bar.geojson
            const encodedName = urlParts[urlParts.length - 1];
            const assetName = decodeURIComponent(encodedName);

            console.log(`Looking for asset '${assetName}' in release 'inbox'`);

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get release by tag
            let release;
            try {
              const response = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag: 'inbox'
              });
              release = response.data;
            } catch (e) {
               console.log("Could not find release 'inbox'. Error:", e.message);
               return;
            }

            // Find asset
            const asset = release.assets.find(a => a.name === assetName);

            if (!asset) {
               console.log(`Asset '${assetName}' not found in release 'inbox'. It may have been deleted already. Available assets: ${release.assets.map(a => a.name).join(', ')}`);
               return;
            }

            // Delete asset
            try {
              await github.rest.repos.deleteReleaseAsset({
                owner,
                repo,
                asset_id: asset.id
              });
              console.log(`Successfully deleted asset '${assetName}' (id: ${asset.id})`);
            } catch (e) {
              // If it's a 404, we can ignore it as "already deleted"
              if (e.status === 404) {
                 console.log(`Asset '${assetName}' (id: ${asset.id}) not found (404) during deletion. Considered already deleted.`);
              } else {
                 console.log(`Failed to delete asset. Error: ${e.message}`);
                 throw e;
              }
            }
